# Canvas Studio 前端任务分解

## 当前进度分析

### ✅ 已完成组件

| 组件 | 文件路径 | 完成度 | 说明 |
|------|----------|--------|------|
| WorkflowCanvas | `features/workflow/components/WorkflowCanvas.tsx` | ✅ 90% | ReactFlow 画布主体，集成背景/缩略图/工具栏 |
| Toolbar | `features/workflow/components/Toolbar.tsx` | ✅ 80% | 左侧工具栏（添加节点、模式切换、整理布局），功能待实现 |
| UndoRedo | `features/workflow/components/UndoRedo.tsx` | ✅ 100% | 撤销/重做按钮 + 快捷键 |
| ZoomControls | `features/workflow/components/ZoomControls.tsx` | ✅ 100% | 缩放控制（放大/缩小/适应/百分比显示） |
| HistoryPanel | `features/workflow/components/HistoryPanel.tsx` | ✅ 100% | 历史记录面板，支持跳转/清除 |
| Tooltip | `features/workflow/components/Tooltip.tsx` | ✅ 100% | 工具提示 + 快捷键显示 |
| Divider | `features/workflow/components/Divider.tsx` | ✅ 100% | 分割线组件 |
| PortalToFollowElem | `components/PortalToFollowElem.tsx` | ✅ 100% | 浮动定位（基于 floating-ui） |
| ShortcutsName | `components/ShortcutsName.tsx` | ✅ 100% | 快捷键名称显示（跨平台） |

### ✅ 已完成 Hooks/Store

| 模块 | 文件路径 | 完成度 | 说明 |
|------|----------|--------|------|
| useWorkflowStore | `store/useWorkflowStore.ts` | ✅ 100% | Zustand 状态管理 + 历史记录(zundo) |
| useWorkflowHistory | `hooks/useWorkflowHistory.ts` | ✅ 100% | 撤销/重做逻辑封装 |
| useAutoLayout | `hooks/useAutoLayout.ts` | ✅ 100% | dagre 自动布局 |

### ✅ 已完成基础设施

- TailwindCSS 配置（语义化颜色变量）
- 类型定义（ControlMode、历史事件类型）
- 工具函数（cn、TooltipManager）

---

## ❌ 待完成功能（按优先级排序）

### P0 - 核心画布功能

#### 1. 自定义节点组件
**需求**：替换 ReactFlow 默认节点，实现业务节点样式
- [x] 基础节点容器（标题栏 + 内容区 + 端口）
- [x] 节点状态显示（queued/running/succeeded/failed/canceled）
- [x] 节点进度条
- [x] 节点选中/hover 样式
- [x] 节点端口（输入/输出 Handle）

#### 2. 自定义边组件
**需求**：支持触发模式标识
- [x] 边的基础样式（smoothstep）
- [x] auto/manual 模式标识（边上 tag/颜色区分）
- [x] 边选中样式

#### 3. 右侧配置面板
**需求**：节点参数编辑
- [x] 面板容器（固定式，简化版，后续补表单/保存逻辑）
- [x] 面板 Header 样式（图标/标题/类型徽标/状态标签/右侧操作区）
- [ ] 节点表单渲染（基于 schema）
- [ ] 表单保存/取消
- [ ] 面板开关逻辑（双击节点打开）

#### 4. 节点选择器（添加节点面板）
**需求**：工具栏"+"按钮点击后的节点列表
- [x] 节点分类展示（简化版浮层，样式对齐 Dify）
- [x] 搜索输入框（占位，待接入过滤逻辑）
 - [x] 点击/拖拽添加（已创建节点并记录快照，拖拽使用 ReactFlow drop）

### P0 - 运行态 UI

#### 5. 运行状态展示
**需求**：节点执行时的实时反馈
 - [x] 节点状态图标/颜色（状态圆点+标签，失败显示错误提示）
 - [x] 进度百分比显示
 - [x] 失败错误提示
- [ ] "查看详情/重试"按钮

#### 6. SSE 订阅 Hook
**需求**：监听后端事件流
- [x] useSSE hook（占位，支持 mockEmitter/URL）
- [x] 运行状态同步到节点 data.runtime（占位，待接入实际事件）

### P1 - 画布交互增强

#### 7. 边配置面板
**需求**：点击边时编辑触发设置
- [x] trigger_mode 切换（占位 UI，待接字段）
- [x] trigger_policy 选择（占位 UI，待接字段）
- [x] 面板 UI（简化版）

#### 8. 输出节点自动插入
**需求**：运行成功后自动创建产物节点
- [x] Asset 节点类型（占位）
- [x] 插入位置计算（占位，待接入运行结果）
- [x] 自动连线（占位）
- [x] 支持撤销（占位）

#### 9. 画布持久化
**需求**：保存/恢复画布状态
- [x] 调用 API 保存 graph_json（占位，当前本地存储）
- [x] 启动时加载画布（占位，使用本地存储）
- [x] 版本冲突提示（占位）
- [x] 自动保存（占位，待接入 debounce）

### P1 - 节点类型

#### 10. 节点类型注册系统（前端部分）
**需求**：与 packages/node-types 对齐
- [x] 节点类型定义（占位，已建 nodes.ts）
- [x] 节点组件注册（nodeTypes map）
- [x] 节点图标/分类（占位）

#### 11. 具体节点类型
- [x] ComfyUI 图片节点（占位）
- [x] ComfyUI 视频节点（占位）
- [x] 第三方图片 API 节点（占位）
- [x] 第三方视频 API 节点（占位）
- [x] Asset 节点（图片/视频展示，占位）

### P2 - 体验优化

#### 12. 运行历史侧边栏
**需求**：查看同一节点的多次运行记录
- [x] 侧边栏 UI（占位）
- [x] 运行记录列表（占位）
- [x] 状态/时间/产物预览（占位）

#### 13. 错误提示系统
**需求**：友好的错误展示
- [x] Toast 组件（占位）
- [x] 错误面板（占位）

#### 14. 快捷键系统完善
- [x] V 切换指针模式
- [x] H 切换手掌模式
- [x] Delete 删除选中（占位）
- [x] Ctrl+A 全选（占位）
- [x] 更多快捷键...（占位）

---

## 推荐开发顺序

```
Phase 1: 节点基础（1-2天）
├── 自定义节点组件
├── 自定义边组件
└── 节点类型注册

Phase 2: 配置交互（1-2天）
├── 右侧配置面板
├── 节点选择器
└── 边配置面板

Phase 3: 运行态（1-2天）
├── SSE 订阅 Hook
├── 运行状态展示
└── 输出节点自动插入

Phase 4: 持久化（0.5天）
└── 画布持久化

Phase 5: 完善（1-2天）
├── 具体节点类型
├── 运行历史侧边栏
└── 错误提示系统
```

---

## 关键文件路径

### 需要新增的文件
```
apps/web/src/
├── features/workflow/
│   ├── components/
│   │   ├── nodes/           # 自定义节点
│   │   │   ├── BaseNode.tsx
│   │   │   ├── ComfyImageNode.tsx
│   │   │   ├── AssetNode.tsx
│   │   │   └── index.ts
│   │   ├── edges/           # 自定义边
│   │   │   ├── AutoEdge.tsx
│   │   │   └── index.ts
│   │   ├── panels/          # 面板
│   │   │   ├── NodeConfigPanel.tsx
│   │   │   ├── EdgeConfigPanel.tsx
│   │   │   ├── NodeSelector.tsx
│   │   │   └── RunHistoryPanel.tsx
│   │   └── ui/              # 通用 UI
│   │       ├── Toast.tsx
│   │       └── ProgressBar.tsx
│   ├── hooks/
│   │   ├── useSSE.ts
│   │   ├── useCanvasPersist.ts
│   │   └── useNodeRun.ts
│   └── types/
│       └── nodes.ts         # 节点类型定义
├── components/
│   └── Toast/               # Toast 组件
└── hooks/
    └── useToast.ts
```

### 需要修改的文件
```
apps/web/src/
├── ui/App.tsx                    # 集成配置面板
├── features/workflow/
│   ├── components/
│   │   ├── WorkflowCanvas.tsx    # 注册自定义节点/边
│   │   └── Toolbar.tsx           # 实现添加节点功能
│   └── store/
│       └── useWorkflowStore.ts   # 添加运行态状态
```
