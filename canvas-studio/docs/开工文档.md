# AIGC 自由画布（Canvas）开工文档 v0.1

## 0. 目标与非目标

**目标**
- 一个自由画布（类似白板/自由编排），可拖拽节点、连线。
- 节点可单独运行（点击运行），也支持通过连线配置**自动触发**（上游产物产生后自动跑下游）。
- 节点类型（首批）：
  - ComfyUI 图片生成
  - ComfyUI 视频生成
  - 第三方图片生成/编辑（HTTP API）
  - 第三方视频生成/编辑（HTTP API）
  - 资产节点（Image/Video Asset Node）：展示产物、作为下游输入
- 运行进度实时更新（SSE），产物上传 OSS，画布自动插入输出节点并连线。

**非目标（明确不做）**
- 多人协作、租户/权限体系、插件市场、RAG/知识库、复杂应用管理、支付计费等平台能力。

## 1. 总体架构

### 1.1 组件划分
- `web`：Vite + React + Tailwind + ReactFlow，自由画布 UI
- `api`：Fastify(TS)，提供 Canvas/Node/Run/Asset API + SSE 事件流 + 自动触发编排
- `worker`：BullMQ Worker(TS)，执行耗时任务（ComfyUI/第三方 API）、上传 OSS、回写运行状态与产物
- `redis`：BullMQ 队列 +（可选）运行事件 pub/sub
- `db`：SQLite（先单机简单），后续可换 Postgres
- `oss`：阿里云 OSS/腾讯 COS/MinIO（推荐先支持 S3 兼容接口，未来可切换）

### 1.2 核心思想
- **节点不需要开始/结束节点**：画布是数据流图，执行以“节点运行（node_run）”为单位。
- **连线 = 数据依赖 + 触发规则**：edge 上定义 `manual/auto` 和触发策略。
- **一次运行就是一个 Job**：`node_run` 有完整输入快照、输出引用、日志与 `trace_id`，可重试、可回放。

## 2. 仓库结构建议（Monorepo）

```text
aigc-canvas/
  apps/
    web/                 # Vite + React
    api/                 # Fastify + TS
    worker/              # BullMQ worker + TS
  packages/
    shared/              # 类型、事件、错误码、schema
    node-types/          # NodeType 定义：表单/端口/输出规则/版本
  docker/
    docker-compose.yml   # redis + (可选) minio + api + worker
  docs/
    开工文档.md
```

包管理建议：`pnpm` + `turbo`（或 `pnpm -r`）均可。

## 3. 数据模型（SQLite 起步）

### 3.1 表：canvas

- 存画布整体快照（节点/边/布局），单人场景足够。
- 后续要做历史版本可加 `canvas_snapshot`。

字段建议：
- `id` (uuid)
- `name` (text)
- `graph_json` (text) 画布 JSON（nodes/edges/viewport）
- `version` (int) 乐观锁
- `created_at` / `updated_at`

### 3.2 表：node_run（作业实例）

字段建议：
- `id` (uuid)
- `canvas_id` (uuid)
- `node_id` (text) 前端生成的 node uuid（存在 graph_json 内）
- `node_type` (text) 如 `comfy.image.v1`
- `status` (text) `queued|running|succeeded|failed|canceled`
- `trigger_source` (text) `manual|auto`
- `idempotency_key` (text, unique) 自动触发/重试防重
- `input_snapshot_json` (text) 本次运行输入快照（包含引用 `asset_id`）
- `params_snapshot_json` (text) 参数快照（含 NodeType 版本）
- `output_json` (text) 输出（`asset_id` 列表 + 端口映射）
- `error_json` (text)
- `progress` (int 0-100)
- `parent_run_id` (uuid, nullable) 自动触发来源
- `hop` (int) 触发深度（防循环风暴）
- `created_at` / `started_at` / `finished_at`

### 3.3 表：asset（产物）

字段建议：
- `id` (uuid)
- `canvas_id` (uuid)
- `type` (text) `image|video`
- `mime` (text)
- `size_bytes` (int)
- `width`/`height`/`duration_ms` (nullable)
- `oss_key` (text)
- `url` (text) 可为长期 URL 或短期签名 URL
- `thumbnail_oss_key`/`thumbnail_url` (nullable)
- `meta_json` (text) seed、prompt、workflow、费用、耗时等
- `source_run_id` (uuid)
- `created_at`

### 3.4 可选表：event（调试/回放用）

若你想“可回放/可追踪”，可以把 run 事件落库：
- `id`, `run_id`, `type`, `payload_json`, `created_at`

## 4. 图模型（前端/后端统一）

### 4.1 Node（画布节点）

每个节点建议包含：
- `id`
- `type`（NodeType）
- `position`
- `data`：
  - `params`（表单值）
  - `ports`（输入/输出端口定义快照：类型、是否多值）
  - `ui`（标题、图标等）
  - `runtime`（最近一次 `run_id`、状态、进度）

### 4.2 Edge（连线）

Edge 建议包含：
- `id`
- `source`/`sourceHandle`
- `target`/`targetHandle`
- `data`：
  - `trigger_mode: manual|auto`
  - `trigger_policy: all_inputs_ready|each_new_asset`
  - `enabled: boolean`

## 5. API 设计（Fastify）

### 5.1 Canvas
- `POST /api/canvases` 创建画布
- `GET /api/canvases/:id` 获取画布
- `PUT /api/canvases/:id` 保存画布（带 `version` 乐观锁）
- `GET /api/canvases/:id/assets` 画布资产列表
- `GET /api/canvases/:id/runs?nodeId=` 查询运行记录

### 5.2 Node 运行
- `POST /api/canvases/:id/nodes/:nodeId/run`
  - body: `{ triggerSource: "manual", reason?: string }`
  - 返回：`{ runId }`
- `POST /api/runs/:runId/cancel`
- `POST /api/runs/:runId/retry`（会生成新 run 或复用幂等键策略）
- `GET /api/runs/:runId`（状态详情）
- `GET /api/runs/:runId/events`（SSE）

### 5.3 SSE 事件格式（建议）

SSE event types：
- `run.created`
- `run.started`
- `run.progress`
- `run.log`
- `asset.created`
- `run.succeeded`
- `run.failed`
- `run.canceled`
- `auto.triggered`（下游自动触发已创建）

Payload 示例（JSON）：
- `run.progress`：`{ runId, progress, message? }`
- `asset.created`：`{ runId, asset: { id, type, url, meta } }`
- `run.succeeded`：`{ runId, outputs: { assets: [...], byPort: {...} } }`

前端订阅策略：
- 点击运行后订阅该 `runId` 的 SSE
- 后期可扩展 `GET /api/canvases/:id/events` 聚合推送（减少连接数）

## 6. 自动触发（核心机制）

### 6.1 触发时机

当某 `node_run` 进入 `succeeded`，后端：
1. 从 DB 取该 canvas 的 `graph_json`
2. 找所有从该 node 出发的 edge，且 `trigger_mode=auto && enabled=true`
3. 对每个下游节点：
   - 装配输入：根据 edge 端口映射，把上游输出 `asset_id` 写入下游 `input_snapshot`
   - 检查下游是否 `all_inputs_ready`
   - 生成下游 run（见幂等）

### 6.2 幂等键（必须）

`idempotency_key = sha256(canvasId + targetNodeId + sorted(inputAssetIds) + stable(paramsSnapshot) + nodeTypeVersion)`

- 自动触发创建 run 时先查 `node_run.idempotency_key` 是否存在且已成功/运行中，存在则不重复创建。
- 手动运行可选择绕过幂等（但建议也提供“相同输入不重复跑”的选项）。

### 6.3 防循环/防风暴（必须）

- 默认禁止创建会形成环的 auto edge（前端连线时提示；后端保存时二次校验）。
- 如允许环，必须配置：
  - `max_hops`（默认 10）
  - `max_auto_runs_per_minute`（例如 30）
  - `max_runs_per_node_per_hour`（例如 200，自用也要保护机器）

## 7. Worker 执行规范（BullMQ）

### 7.1 队列与并发

建议按资源类型拆队列（后期可区分 GPU/CPU）：
- `queue: comfy`（并发 1~2，避免本地 GPU 爆）
- `queue: image_api`
- `queue: video_api`

Job payload：
- `{ runId }`（worker 自己去 DB 拉取 input/params，避免 payload 过大）

### 7.2 执行流程（统一范式）

1. worker 取 run -> 标记 `running` -> 发 SSE `run.started`
2. 调用执行器（Comfy/第三方）：
   - 定期上报进度 `run.progress`
   - 产物文件落本地临时目录
3. 上传 OSS -> 写 `asset` 记录 -> 发 SSE `asset.created`
4. 写回 run `output_json` + `succeeded` -> 发 SSE `run.succeeded`
5. api 端监听到 succeeded（或 worker 回调 api） -> 进行 auto-trigger

### 7.3 取消语义

- `cancel`：将 run 标记 `canceled`，worker 尝试：
  - ComfyUI：若有 job id，尝试取消；若不支持则标记取消并停止后续流程
- 取消后不触发下游 auto

## 8. 节点类型（NodeType）规范（配置驱动）

每个 NodeType 定义：
- `type`: `comfy.image.v1`
- `displayName`/`icon`/`category`
- `inputs`: 端口列表（type、是否必填、是否多值）
- `outputs`: 端口列表
- `formSchema`: 用 `zod` 或 `json schema` 定义表单与校验
- `executor`: `comfy` / `http` 等
- `outputNodeFactory`: 运行成功后如何生成输出节点（ImageAssetNode/VideoAssetNode）
- `version`: `1`

### 8.1 ComfyUI 节点（推荐模板化）

- `comfy_template`：workflow JSON + 可参数化映射规则（例如 JSONPath/节点 id + 字段）
- 节点表单只描述“映射参数”，运行时把表单值注入 workflow JSON 后提交给 ComfyUI。

## 9. 前端实现要点（Vite + ReactFlow）

### 9.1 关键交互

- 节点点击 -> 右侧面板编辑参数（本地状态 + 保存到后端）
- 运行按钮：
  - `POST run` -> 获取 `runId`
  - 订阅 SSE -> 更新节点状态/进度
  - `asset.created` -> 在画布插入 AssetNode 并连线（前端先乐观插入，再保存画布）
- Edge 配置：
  - 点击边 -> 切换 `manual/auto`
  - 设置 `trigger_policy`

### 9.2 自动插入节点布局策略（简单可用）

- 输出节点位置：在源节点右侧 `+ (300, 0)`，若冲突则向下偏移栅格。
- 连线：source output port -> asset node input（或直接无 input，仅展示）。

## 10. 本地部署（Docker）

建议 `docker-compose.yml` 最小包含：
- redis
- api
- worker
- （可选）minio（如果不想一开始就依赖真实 OSS）

环境变量：
- `REDIS_URL`
- `DB_PATH`（sqlite 文件）
- `OSS_ENDPOINT/OSS_BUCKET/OSS_ACCESS_KEY/OSS_SECRET`
- `COMFY_ENDPOINT`（本地 comfyui 地址）

## 11. 开发里程碑（两周可落地节奏）

**M0（第 1-2 天）**
- 初始化 monorepo、api/worker/web 空壳、docker 起 redis

**M1（第 3-5 天）**
- 画布 CRUD（保存 `graph_json`）
- node_run 创建 + SSE 通道打通（先用 fake worker 模拟进度）

**M2（第 6-9 天）**
- 接入 OSS 上传 + asset 节点自动插入
- 接入第三方图片 API 节点（HTTP executor）

**M3（第 10-14 天）**
- 接入 ComfyUI 图片节点（模板化）
- auto edge：上游成功触发下游 + 幂等 + `all_inputs_ready`
- 防循环/防风暴基础保护

## 12. 风险清单（开工前统一认知）

- “自动触发”必须有幂等与限速，否则容易无限跑、无限生成节点。
- ComfyUI 视频节点耗时长，SSE 心跳/重连要做好（前端断线后可通过 `GET /runs/:id` 恢复状态）。
- OSS URL 建议走签名（即使自用也建议），否则未来暴露出去会麻烦。

